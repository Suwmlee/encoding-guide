<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>颗粒化(Graining) - 高级编码指南</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">介绍</a></li><li class="chapter-item expanded "><a href="../filtering/filtering.html"><strong aria-hidden="true">1.</strong> 过滤Filtering</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">1.1.</strong> 载入视频Loading the Video</div></li><li class="chapter-item expanded "><a href="../filtering/cropping.html"><strong aria-hidden="true">1.2.</strong> 裁剪Cropping</a></li><li class="chapter-item expanded "><a href="../filtering/resizing.html"><strong aria-hidden="true">1.3.</strong> 调整大小(Resizing)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../filtering/descaling.html"><strong aria-hidden="true">1.3.1.</strong> 解放缩(descaling)与重新缩放(rescaling)</a></li><li class="chapter-item expanded "><a href="../filtering/chroma_res.html"><strong aria-hidden="true">1.3.2.</strong> 色度重采样与偏移(Chroma Resampling and Shifting)</a></li></ol></li><li class="chapter-item expanded "><a href="../filtering/bit_depths.html"><strong aria-hidden="true">1.4.</strong> 位深(Bit Depths)与抖动算法(Dither Algorithms)</a></li><li class="chapter-item expanded "><a href="../filtering/debanding.html"><strong aria-hidden="true">1.5.</strong> 解带(Debanding)与解块(Deblocking)</a></li><li class="chapter-item expanded "><a href="../filtering/graining.html" class="active"><strong aria-hidden="true">1.6.</strong> 颗粒化(Graining)</a></li><li class="chapter-item expanded "><a href="../filtering/dirty_lines.html"><strong aria-hidden="true">1.7.</strong> 脏线(Dirty Lines)与边界问题(Border Issues)</a></li><li class="chapter-item expanded "><a href="../filtering/detinting.html"><strong aria-hidden="true">1.8.</strong> 除着色(Detinting)与水平调整(Level Adjustment)</a></li><li class="chapter-item expanded "><a href="../filtering/masking.html"><strong aria-hidden="true">1.9.</strong> 蒙版(Masking)</a></li><li class="chapter-item expanded "><a href="../filtering/anti-aliasing.html"><strong aria-hidden="true">1.10.</strong> 抗锯齿(Anti-Aliasing)</a></li><li class="chapter-item expanded "><a href="../filtering/deringing.html"><strong aria-hidden="true">1.11.</strong> 消除振铃(Deringing)</a></li><li class="chapter-item expanded "><a href="../filtering/dehaloing.html"><strong aria-hidden="true">1.12.</strong> 去晕(Dehaloing)</a></li><li class="chapter-item expanded "><a href="../filtering/denoising.html"><strong aria-hidden="true">1.13.</strong> 降噪(Denoising)</a></li><li class="chapter-item expanded "><a href="../filtering/dehardsubbing.html"><strong aria-hidden="true">1.14.</strong> 剔除硬字幕(Dehardsubbing)与去台标(Delogoing)</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> 编码Encoding</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../encoding/testing.html"><strong aria-hidden="true">2.1.</strong> 测试编码(Test Encodes)</a></li><li class="chapter-item expanded "><a href="../encoding/x264.html"><strong aria-hidden="true">2.2.</strong> x264 Settings</a></li><li class="chapter-item expanded "><a href="../encoding/x265.html"><strong aria-hidden="true">2.3.</strong> x265 Settings</a></li><li class="chapter-item expanded "><a href="../encoding/screenshots.html"><strong aria-hidden="true">2.4.</strong> 截图和对比(Screenshots and Comparisons)</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> 音频Audio</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">3.1.</strong> SoX: 抖动和向下混合(Dithering and Down-Mixing)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> 单声道和立体声(Mono and Stereo)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> 环绕声(Surround Sound)</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> 附录Appendix</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">4.1.</strong> 线性光处理(Linear Light Processing)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.2.</strong> 使用FT寻找最佳分辨率</div></li><li class="chapter-item expanded "><a href="../appendix/grain_matching.html"><strong aria-hidden="true">4.3.</strong> 颗粒匹配(Grain Matching)</a></li><li class="chapter-item expanded "><a href="../appendix/gray.html"><strong aria-hidden="true">4.4.</strong> 黑白剪辑(Black &amp; White Clips)</a></li></ol></li><li class="chapter-item expanded "><a href="../scriptorium.html"><strong aria-hidden="true">5.</strong> Scriptorium</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">高级编码指南</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="颗粒化"><a class="header" href="#颗粒化">颗粒化</a></h1>
<p>TODO: 解释为什么我们这么喜欢颗粒，以及静态与动态颗粒。 还有，图像。</p>
<h1 id="颗粒过滤器"><a class="header" href="#颗粒过滤器">颗粒过滤器</a></h1>
<p>你可以用几个不同的过滤器来颗粒化。
由于很多函数的工作原理类似，我们将只介绍AddGrain和libplacebo颗粒。</p>
<h2 id="addgrain"><a class="header" href="#addgrain">AddGrain</a></h2>
<p>这个插件允许你以不同的强度和颗粒模式在luma和chroma颗粒中添加颗粒。</p>
<pre><code class="language-py">grain = src.grain.Add(var=1.0, uvar=0.0, seed=-1, constant=False)
</code></pre>
<p>这里，<code>var</code>设置luma面的颗粒强度，<code>uvar</code>设置chroma面的强度。
<code>seed</code>允许你指定一个自定义的颗粒模式，如果你想多次复制一个颗粒模式，例如用于比较编码，这很有用。
<code>constant</code>允许你在静态和动态纹理之间进行选择。</p>
<p>提高强度既可以增加颗粒的数量，也可以增加颗粒像素与原始像素的偏移。
例如，`var=1'会导致数值与输入值相差3个8位数。</p>
<p>直接使用这个函数没有实际意义，但知道它的作用是很好的，因为它被认为是常用的颗粒器。</p>
<details>
<summary>深入解释</summary>
这个插件使用正态分布来寻找它改变输入的值。
参数 `var` 是正态分布的标准差 (通常记做 \(\sigma\)) 。
<p>这意味着 (这些都是近似值):</p>
<ul>
<li>\(68.27\%\) 的输出像素值在输入值的 \(\pm1\times\mathtt{var}\) 倍以内</li>
<li>\(95.45\%\) 的输出像素值在输入值的 \(\pm2\times\mathtt{var}\) 倍以内</li>
<li>\(99.73\%\) 的输出像素值在输入值的 \(\pm3\times\mathtt{var}\) 倍以内</li>
<li>\(50\%\) 的输出像素值在输入值的 \(\pm0.675\times\mathtt{var}\) 倍以内</li>
<li>\(90\%\) 的输出像素值在输入值的 \(\pm1.645\times\mathtt{var}\) 倍以内</li>
<li>\(95\%\) 的输出像素值在输入值的 \(\pm1.960\times\mathtt{var}\) 倍以内</li>
<li>\(99\%\) 的输出像素值在输入值的 \(\pm2.576\times\mathtt{var}\) 倍以内</li>
</ul>
</details>
<h2 id="placebodeband-as-a-grainer"><a class="header" href="#placebodeband-as-a-grainer">placebo.Deband as a grainer</a></h2>
<p>另外，只用<code>placebo.Deband</code>作为一个颗粒器，也能带来一些不错的结果。</p>
<pre><code class="language-py">grain = placebo.Deband(iterations=0, grain=6.0)
</code></pre>
<p>这里的主要优势是它在你的GPU上运行，所以如果你的GPU还没有忙于其他的过滤器，使用这个可以让你的速度略有提高。</p>
<details>
<summary>深入解释</summary>
TODO
</details>
<h2 id="adaptive_grain"><a class="header" href="#adaptive_grain">adaptive_grain</a></h2>
<p>这个函数来自<a href="https://github.com/Irrational-Encoding-Wizardry/kagefunc"><code>kagefunc</code></a>，根据整体帧亮度和单个像素亮度应用AddGrain。
这对于掩盖小的条带和/或帮助x264将更多的比特分配给暗部非常有用。</p>
<pre><code class="language-py">grain = kgf.adaptive_grain(src, strength=.25, static=True, luma_scaling=12, show_mask=False)
</code></pre>
<p>这里的<code>强度</code>是AddGrain的<code>var</code>。
默认值或稍低的值通常是好的。
你可能不希望超过0.75。</p>
<p><code>luma_scaling</code>参数用于控制它对暗色帧的偏爱程度，即较低的<code>luma_scaling</code>将对亮色帧应用更多的纹理。
你可以在这里使用极低或极高的值，这取决于你想要什么。
例如，如果你想对所有的帧进行明显的纹理处理，你可以使用<code>luma_scaling=5</code>，而如果你只想对较暗的帧的暗部进行纹理处理以掩盖轻微的带状物，你可以使用<code>luma_scaling=100</code>。</p>
<p><code>show_mask</code>显示用于应用纹理的遮罩，越白意味着应用的纹理越多。
建议在调整<code>luma_scaling</code>时打开它。</p>
<details>
<summary>深入解释</summary>
该方法的作者写了一篇<a href="https://blog.kageru.moe/legacy/adaptivegrain.html">精彩的博文，解释了该函数和它的工作原理</a>。
</details>
<h2 id="grainfactory3"><a class="header" href="#grainfactory3">GrainFactory3</a></h2>
<p>TODO：重写或直接删除它。</p>
<p>作为<code>kgf.adaptive_grain</code>的一个较早的替代品，<a href="https://github.com/HomeOfVapourSynthEvolution/havsfunc"><code>havsfunc</code></a>的<code>GrainFactory3</code>仍然相当有趣。
它根据像素值的亮度将其分成四组，并通过AddGrain将不同大小的颗粒以不同的强度应用于这些组。</p>
<pre><code class="language-py">grain = haf.GrainFactory3(src, g1str=7.0, g2str=5.0, g3str=3.0, g1shrp=60, g2shrp=66, g3shrp=80, g1size=1.5, g2size=1.2, g3size=0.9, temp_avg=0, ontop_grain=0.0, th1=24, th2=56, th3=128, th4=160)
</code></pre>
<p>参数的解释<a href="https://github.com/HomeOfVapourSynthEvolution/havsfunc/blob/master/havsfunc.py#L3720">在源代码上面</a>。</p>
<p>这个函数主要是在你想只对特定的帧应用颗粒时有用，因为如果对整个视频应用颗粒，应该考虑整体的帧亮度。</p>
<p>例如，<code>GrainFactory3</code> 可以弥补左右边框的颗粒缺失:</p>
<p align="center"> 
<img src='Pictures/grain0.png' onmouseover="this.src='Pictures/grain1.png';" onmouseout="this.src='Pictures/grain0.png';" />
</p>
<details>
<summary>深入解释</summary>
TODO
<p>简而言之：为每个亮度组创建一个蒙版，使用双曲线调整大小，用锐度控制b和c来调整纹理的大小，然后应用这个。
时间平均法只是使用misc.AverageFrames对当前帧和其直接邻接的纹理进行平均。</p>
</details>
<h2 id="adptvgrnmod"><a class="header" href="#adptvgrnmod">adptvgrnMod</a></h2>
<p>这个函数以<code>GrainFactory3</code>的方式调整颗粒大小，然后使用<code>adaptive_grain</code>的方法进行应用。
它还对暗部和亮部进行了一些保护，以保持平均帧亮度。</p>
<pre><code class="language-py">grain = agm.adptvgrnMod(strength=0.25, cstrength=None, size=1, sharp=50, static=False, luma_scaling=12, seed=-1, show_mask=False)
</code></pre>
<p>颗粒强度由luam的<code>strength</code>和chroma的<code>cstrength</code>控制。
<code>cstrength</code>默认为<code>strength</code>的一半。
就像<code>adaptive_grain</code>一样，默认值或稍低的值通常是好的，但你不应该太高。
如果你使用的<code>size</code>大于默认值，你可以用更高的值，例如<code>strength=1</code>，但还是建议对颗粒应用保持保守。</p>
<p><code>size</code> and <code>sharp</code> 参数允许你使应用的颗粒看起来更像电影的其他部分。
建议对这些参数进行调整，以便使假的颗粒不会太明显。
在大多数情况下，你会想稍微提高这两个参数，例如：<code>size=1.2, sharp=60</code>。</p>
<p><code>static</code>、<code>luma_scaling</code>和<code>show_mask</code>等同于<code>adaptive_grain</code>，所以看上面的解释。
<code>seed</code>与AddGrain的相同；同样，向上面解释。</p>
<p>默认情况下，<code>adptvgrnMod</code>会淡化极值（16或235）附近的纹理和灰色的阴影。
这些功能可以通过设置<code>fade_edges=False</code>和<code>protect_neutral=False</code>分别关闭。</p>
<p>最近，用这个功能从一个人的磨光机中完全去除颗粒，并将磨光的区域完全磨光，这已成为普遍的做法。</p>
<h3 id="sizedgrn"><a class="header" href="#sizedgrn">sizedgrn</a></h3>
<p>如果想禁用基于亮度的应用，可以使用<code>sizedgrn</code>，它是<code>adptvgrnMod</code>中的内部粒度函数。</p>
<details>
<summary>一些 <code>adptvgrnMod</code> 与 <code>sizedgrn</code> 对比的例子，供好奇的人参考</summary>
<p>一个明亮的场景，基于亮度的应用产生了很大的差异:</p>
<p align="center"> 
<img src='Pictures/graining4.png' onmouseover="this.src='Pictures/graining7.png';" onmouseout="this.src='Pictures/graining4.png';" />
</p>
<p>一个整体较暗的场景，其中的差异要小得多:</p>
<p align="center"> 
<img src='Pictures/graining3.png' onmouseover="this.src='Pictures/graining6.png';" onmouseout="this.src='Pictures/graining3.png';" />
</p>
<p>一个黑暗的场景，在画面中的每一个地方都均匀地（几乎）应用了颗粒:</p>
<p align="center"> 
<img src='Pictures/graining5.png' onmouseover="this.src='Pictures/graining8.png';" onmouseout="this.src='Pictures/graining5.png';" />
</p>
</details>
<details>
<summary>深入解释</summary>
(该功能的作者的旧文。)
<h3 id="size-and-sharpness"><a class="header" href="#size-and-sharpness">Size and Sharpness</a></h3>
<p>adptvgrnMod的颗粒化部分与GrainFactory3的相同；它在尺寸参数定义的分辨率下创建一个 &quot;空白&quot;（比特深度的中间点）剪辑，然后通过一个使用由sharp决定的b和c值的二次方内核进行扩展:</p>
<p>$$\mathrm{grain\ width} = \mathrm{mod}4 \left( \frac{\mathrm{clip\ width}}{\mathrm{size}} \right)$$</p>
<p>例如，一个1920x1080的片段，尺寸值为1.5:</p>
<p>$$ \mathrm{mod}4 \left( \frac{1920}{1.5} \right) = 1280 $$</p>
<p>这决定了颗粒器所操作的帧的大小。</p>
<p>现在，决定使用bicubic kernel的参数:</p>
<p>$$ b = \frac{\mathrm{sharp}}{-50} + 1 $$
$$ c = \frac{1 - b}{2} $$</p>
<p>这意味着，对于默认的50的锐度，使用的是Catmull-Rom过滤器:</p>
<p>$$ b = 0, \qquad c = 0.5 $$</p>
<p>Values under 50 will tend towards B-Spline (b=1, c=0), while ones above 50 will tend towards b=-1, c=1. As such, for a Mitchell (b=1/3, c=1/3) filter, one would require sharp of 100/3.</p>
<p>The grained &quot;blank&quot; clip is then resized to the input clip's resolution with this kernel. If size is greater than 1.5, an additional resizer call is added before the upscale to the input resolution:</p>
<p>$$ \mathrm{pre\ width} = \mathrm{mod}4 \left( \frac{\mathrm{clip\ width} + \mathrm{grain\ width}}{2} \right) $$</p>
<p>With our resolutions so far (assuming we did this for size 1.5), this would be 1600.  This means with size 2, where this preprocessing would actually occur, our grain would go through the following resolutions:</p>
<p>$$ 960 \rightarrow 1440 \rightarrow 1920 $$</p>
<h3 id="fade-edges"><a class="header" href="#fade-edges">Fade Edges</a></h3>
<p>The fade_edges parameter introduces the option to attempt to maintain overall average image brightness, similar to ideal dithering. It does so by limiting the graining at the edges of the clip's range. This is done via the following expression:</p>
<pre><code>x y neutral - abs - low &lt; x y neutral - abs + high &gt; or
x y neutral - x + ?
</code></pre>
<p>Here, x is the input clip, y is the grained clip, neutral is the midway point from the previously grained clip, and low and high are the edges of the range (e.g. 16 and 235 for 8-bit luma). Converted from postfix to infix notation, this reads:</p>
<p>\[x = x\ \mathtt{if}\ x - \mathrm{abs}(y - neutral) &lt; low\ \mathtt{or}\ x - \mathrm{abs}(y - neutral) &gt; high\ \mathtt{else}\ x + (y - neutral)\]</p>
<p>The effect here is that all grain that wouldn't be clipped during output regardless of whether it grains in a positive or negative direction remains, while grain that would pass the plane's limits isn't taken.</p>
<p>In addition to this parameter, protect_neutral is also available. This parameter protects &quot;neutral&quot; chroma (i.e. chroma for shades of gray) from being grained. To do this, it takes advantage of AddGrainC working according to a Guassian distribution, which means that
$$max\ value = 3 \times \sigma$$
(sigma being the standard deviation - the strength or cstrength parameter) is with 99.73% certainty the largest deviated value from the norm (0). This means we can perform a similar operation to the one for fade_edges to keep the midways from being grained. To do this, we resize the input clip to 4:4:4 and use the following expression:</p>
<p>\[\begin{align}x \leq (low + max\ value)\ \mathtt{or}\ x \geq (high - max\ value)\ \mathtt{and}\\ \mathrm{abs}(y - neutral) \leq max\ value\ \mathtt{and}\ \mathrm{abs}(z - neutral) \leq max\ value \end{align}\]</p>
<p>With x, y, z being each of the three planes. If the statement is true, the input clip is returned, else the grained clip is returned.</p>
<p>I originally thought the logic behind protect_neutral would also work well for fade_edges, but I then realized this would completely remove grain near the edges instead of fading it.</p>
<p>Now, the input clip and grained clip (which was merged via std.MergeDiff, which is x - y - neutral) can be merged via the adaptive_grain mask.</p>
</details>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../filtering/debanding.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../filtering/dirty_lines.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../filtering/debanding.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../filtering/dirty_lines.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
